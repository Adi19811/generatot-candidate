<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Generator CV - Covebo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- Biblioteki do obsługi PDF i OCR (Obrazki) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  
  <style>
    body { font-family: 'Poppins', sans-serif; touch-action: pan-x pan-y; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    @media (max-width: 768px) {
        .mobile-view-form #cv-preview-container { display: none; }
        .mobile-view-preview #cv-form-container { display: none; }
    }
    .drag-ghost { opacity: 0.4; border: 2px dashed #ef4444; background: #fff5f5; }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-pulse { animation: pulse-red 2s infinite; }
    /* Styl dla zaznaczenia */
    ::selection { background: #fee2e2; color: #991b1b; }
    
    /* Styl dla edytora rich-text */
    .rich-editor b, .rich-editor strong {
        font-weight: 700;
        color: #000;
        background-color: #fef3c7; /* Delikatne podświetlenie pogrubień */
    }
    .rich-editor {
        white-space: pre-wrap; /* Zachowaj formatowanie białych znaków */
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-gray-100 overscroll-none">
  <div id="root"></div>
  <script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom/client';

    // Konfiguracja workera PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- UTILS ---
    const generateUniqueId = () => crypto.randomUUID();

    // --- LOGIKA PARSOWANIA ---
    const parseImportText = (rawText) => {
        const result = {
            workExperience: [],
            education: [],
            personalDetails: [],
            skills: [],
            languages: []
        };
        const cleanLines = rawText.split('\n')
            .map(l => l.trim())
            .filter(l => l.length > 0)
            .filter(l => !l.includes('@'))
            .filter(l => !/^\d{15,}$/.test(l)); 

        const fullText = cleanLines.join('\n');
        
        const keywords = {
            work: ['DOŚWIADCZENIE', 'ZAWODOWE', 'EXPERIENCE', 'WORK', 'ZATRUDNIENIE'],
            edu: ['EDUKACJA', 'WYKSZTAŁCENIE', 'EDUCATION', 'SZKOŁY'],
            skills: ['UPRAWNIENIA', 'UMIEJĘTNOŚCI', 'SKILLS', 'QUALIFICATIONS', 'CERTYFIKATY'],
            lang: ['JĘZYKI', 'LANGUAGES', 'ZNAJOMOŚĆ JĘZYKÓW']
        };

        const getSectionText = (sectionKeys) => {
            let startIdx = -1;
            let matchedKey = "";
            const lowerText = fullText.toLowerCase();
            for (const key of sectionKeys) {
                const idx = lowerText.indexOf(key.toLowerCase());
                if (idx !== -1 && (startIdx === -1 || idx < startIdx)) {
                    startIdx = idx;
                    matchedKey = key;
                }
            }
            if (startIdx === -1) return null;
            const contentStart = startIdx + matchedKey.length;
            let endIdx = fullText.length;
            const allKeywords = Object.values(keywords).flat();
            allKeywords.forEach(k => {
                const kIdx = lowerText.indexOf(k.toLowerCase(), contentStart);
                if (kIdx !== -1 && kIdx < endIdx) {
                    endIdx = kIdx;
                }
            });
            return fullText.substring(contentStart, endIdx).trim();
        };

        const workText = getSectionText(keywords.work);
        if (workText) {
            const lines = workText.split('\n').map(l => l.trim()).filter(l => l);
            const dateRegex = /(\d{4}|obecnie|present|now|\d{2}\.\d{4})/i;
            let currentExp = null;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (dateRegex.test(line) && line.length < 50) {
                    if (currentExp) result.workExperience.push(currentExp);
                    const companyLine = lines[i + 1] ? lines[i + 1] : "Firma / Stanowisko";
                    currentExp = {
                        id: generateUniqueId(),
                        dateRange: line,
                        company: companyLine,
                        jobTitle: "Stanowisko",
                        tasks: []
                    };
                    i++; 
                } else if (currentExp) {
                    currentExp.tasks.push({ id: generateUniqueId(), text: line.replace(/^[•\-\*]\s*/, '') });
                }
            }
            if (currentExp) result.workExperience.push(currentExp);
        }
        return result;
    };

    const translations = {
      pl: {
        editorTitle: "Edytor CV",
        basicInfo: "Dane Podstawowe",
        fullName: "Imię i Nazwisko",
        dob: "Data urodzenia",
        profilePic: "Zdjęcie Profilowe",
        workExp: "Doświadczenie Zawodowe",
        workExpDesc: "Mapowanie treści wyłącznie na podstawie nagłówków dokumentu. Firma jest pogrubiona.",
        addWorkExp: " + Dodaj nowe doświadczenie",
        jobTitle: "Stanowisko",
        company: "Firma",
        period: "Okres (np. 01.2020 - 12.2023)",
        responsibilities: "Zakres obowiązków (lista)",
        dutyPlaceholder: "Obowiązek...",
        addDuty: " + Dodaj obowiązek",
        removeWorkExp: "Usuń to doświadczenie",
        newWorkExp: "Nowe doświadczenie zawodowe",
        qualifications: "Uprawnienia (np. Prawo Jazdy, SEP)",
        languages: "Znajomość Języków Obcych",
        skills: "Dodatkowe Umiejętności",
        education: "Edukacja",
        eduDesc: "Dodaj szkołę / edytuj edukację",
        addEdu: " + Dodaj nowy wpis edukacyjny",
        degree: "Stopień/Kwalifikacja",
        school: "Nazwa instytucji",
        description: "Opis (opcjonalnie)",
        removeEdu: "Usuń tę edukację",
        newEdu: "Nowa szkoła/kurs",
        downloadPdf: "Pobierz CV jako PDF",
        previewDob: "Data urodzenia",
        previewQual: "Uprawnienia",
        previewSkills: "Dodatkowe umiejętności",
        previewLang: "Znajomość języków obcych",
        previewExp: "Doświadczenie",
        previewEdu: "Edukacja",
        previewCV: "Curriculum vitae",
        sectionQual: "Uprawnienia",
        sectionLang: "Znajomość Języków Obcych",
        sectionSkills: "Dodatkowe Umiejętności",
        listDesc: "Edytuj listę poniżej",
        importBtn: "Zczytaj swoje CV",
        importPlaceholder: "Wczytaj plik (PDF lub zdjęcie), aby zobaczyć tekst. Zaznacz fragment i przypisz go przyciskami po prawej.",
        importIntro: "Zaznacz tekst, który chcesz przenieść do szablonu i wybierz kategorię.",
        importOutro: "Poniżej uzupełnisz nowe pozycje, które nie były w Twoim CV.",
        closeBtn: "Zamknij",
        loadFileBtn: "Wczytaj plik",
        importing: "Przetwarzanie...",
        assignTo: "Przypisz zaznaczenie do:",
        assignName: "Imię i Nazwisko",
        assignWork: "Nowe Doświadczenie",
        assignEdu: "Nowa Edukacja",
        assignSkills: "Umiejętności (Lista)",
        assignLangs: "Języki (Lista)",
        assignQuals: "Uprawnienia (Lista)",
        selectionEmpty: "Najpierw zaznacz tekst w polu po lewej!"
      },
      en: {
        editorTitle: "CV Editor",
        basicInfo: "Basic Information",
        fullName: "Full Name",
        dob: "Date of Birth",
        profilePic: "Profile Picture",
        workExp: "Work Experience",
        workExpDesc: "Mapping content strictly based on document headers. Company is bold.",
        addWorkExp: " + Add new experience",
        jobTitle: "Job Title",
        company: "Company",
        period: "Period (e.g. 01.2020 - 12.2023)",
        responsibilities: "Responsibilities (list)",
        dutyPlaceholder: "Duty...",
        addDuty: " + Add duty",
        removeWorkExp: "Remove this experience",
        newWorkExp: "New Work Experience",
        qualifications: "Qualifications",
        languages: "Languages",
        skills: "Additional Skills",
        education: "Education",
        eduDesc: "Add school / edit education",
        addEdu: " + Add new education entry",
        degree: "Degree/Qualification",
        school: "Institution Name",
        description: "Description",
        removeEdu: "Remove this education",
        newEdu: "New School/Course",
        downloadPdf: "Download CV as PDF",
        previewDob: "Date of Birth",
        previewQual: "Qualifications",
        previewSkills: "Additional Skills",
        previewLang: "Languages",
        previewExp: "Experience",
        previewEdu: "Education",
        previewCV: "Curriculum Vitae",
        sectionQual: "Qualifications",
        sectionLang: "Languages",
        sectionSkills: "Additional Skills",
        listDesc: "Edit list below",
        importBtn: "Read your CV",
        importPlaceholder: "Load file (PDF or Image) to see text. Select text and assign it using buttons on the right.",
        importIntro: "Highlight the text you want to transfer to the template and select a category.",
        importOutro: "Below, you can complete new items that were not in your CV.",
        closeBtn: "Close",
        loadFileBtn: "Load file",
        importing: "Processing...",
        assignTo: "Assign selection to:",
        assignName: "Full Name",
        assignWork: "New Experience",
        assignEdu: "New Education",
        assignSkills: "Skills (List)",
        assignLangs: "Languages (List)",
        assignQuals: "Qualifications (List)",
        selectionEmpty: "Select text in the left box first!"
      }
    };

    // --- PDF GENERATOR ---
    const generatePdf = async (elementId) => {
      const originalElement = document.getElementById(elementId);
      if (!originalElement) throw new Error(`Element "${elementId}" not found.`);
      const clone = originalElement.cloneNode(true);
      clone.classList.remove('shadow-2xl'); 
      clone.style.position = 'absolute'; clone.style.top = '0'; clone.style.left = '-9999px';
      clone.style.width = '210mm'; clone.style.height = 'auto'; clone.style.zoom = '1'; clone.style.margin = '0';
      
      let logoDataUrl = null;
      const logoWrapper = clone.querySelector('.cv-logo-wrapper');
      if (logoWrapper) {
          const img = logoWrapper.querySelector('img');
          if (img) {
              try {
                 if (img.complete && img.naturalHeight !== 0) {
                     const canvas = document.createElement('canvas');
                     canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                     canvas.getContext('2d').drawImage(img, 0, 0);
                     logoDataUrl = canvas.toDataURL('image/png');
                 }
              } catch (e) { console.warn("Błąd przetwarzania logo", e); }
          }
          logoWrapper.style.display = 'none';
      }
      document.body.appendChild(clone);
      
      try {
        const scale = 2;
        const canvas = await window.html2canvas(clone, { scale, useCORS: true, logging: false, height: clone.scrollHeight, windowHeight: clone.scrollHeight, scrollY: -window.scrollY });
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        const pxPerMm = canvas.width / 210;
        let startY = 0;
        
        while (startY < canvas.height) {
          if (startY > 0) pdf.addPage();
          const pageHeightPx = Math.min(canvas.height - startY, 297 * pxPerMm);
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = canvas.width; tempCanvas.height = pageHeightPx;
          const ctx = tempCanvas.getContext('2d');
          ctx.fillStyle = '#ffffff'; 
          ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
          ctx.drawImage(canvas, 0, startY, canvas.width, pageHeightPx, 0, 0, canvas.width, pageHeightPx);
          const imgData = tempCanvas.toDataURL('image/jpeg', 0.95);
          pdf.addImage(imgData, 'JPEG', 0, 0, 210, pageHeightPx / pxPerMm);
          if (logoDataUrl) { try { pdf.addImage(logoDataUrl, 'PNG', 210 - 34, 297 - 25, 24, 15); } catch (e) {} }
          startY += pageHeightPx;
        }
        pdf.save('cv.pdf');
      } catch (err) { console.error(err); alert("Błąd PDF."); } finally { document.body.removeChild(clone); }
    };

    // --- ICONS ---
    const ChevronIcon = ({ className }) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement('polyline', { points: "6 9 12 15 18 9" }));
    const DownloadIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement('polyline', { points: "7 10 12 15 17 10" }), React.createElement('line', { x1: "12", y1: "15", x2: "12", y2: "3" }));
    const DragHandleIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('circle', { cx: "9", cy: "5", r: "1" }), React.createElement('circle', { cx: "9", cy: "12", r: "1" }), React.createElement('circle', { cx: "9", cy: "19", r: "1" }), React.createElement('circle', { cx: "15", cy: "5", r: "1" }), React.createElement('circle', { cx: "15", cy: "12", r: "1" }), React.createElement('circle', { cx: "15", cy: "19", r: "1" }));
    const UploadIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement('polyline', { points: "17 8 12 3 7 8" }), React.createElement('line', { x1: "12", y1: "3", x2: "12", y2: "15" }));
    const PlusIcon = ({className}) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement('line', { x1: "12", y1: "5", x2: "12", y2: "19" }), React.createElement('line', { x1: "5", y1: "12", x2: "19", y2: "12" }));

    // --- COMPONENTS ---
    const SectionTitle = ({ children }) => React.createElement('h2', { className: "text-[#E31D2A] text-lg tracking-[0.3em] font-semibold mb-6 uppercase" }, children);

    const CvPreview = ({ cvData, id, className, onImagePositionChange, lang = 'pl' }) => {
      const { name, profilePictureUrl, imagePosition, dob, personalDetails, skills, languages, workExperience, education } = cvData;
      const t = translations[lang]; 
      const hasImage = profilePictureUrl && !profilePictureUrl.includes('placehold.co');
      return React.createElement('div', { id: id, className: `bg-white text-black min-h-[297mm] shadow-2xl flex flex-col ${className}`, style: { fontFamily: "'Poppins', sans-serif" } },
        React.createElement('header', { className: "relative text-white h-[140px]" },
          React.createElement('img', { src: "Covebostopka.png", alt: "Nagłówek", className: "absolute inset-0 w-full h-full object-cover z-0" }),
          React.createElement('div', { className: "relative z-10 flex items-center w-full h-full px-10" },
            React.createElement('div', { className: 'w-1/2 ml-auto flex justify-end items-center text-right' },
              React.createElement('h1', { className: "text-4xl font-bold leading-tight uppercase drop-shadow-md" }, name || 'Imię i Nazwisko')
            )
          ),
          hasImage && React.createElement('div', { 
            className: "absolute left-10 rounded-full bg-white p-2 shadow-lg z-20 cursor-move group", 
            style: { top: `${140 - 75 + 50}px`, width: `150px`, height: `150px` },
            onMouseDown: (e) => { e.preventDefault(); e.stopPropagation(); const startX = e.clientX, startY = e.clientY, startPos = {...imagePosition}; const onMove = (me) => { const dx = me.clientX - startX, dy = me.clientY - startY; onImagePositionChange({ x: Math.max(0, Math.min(100, startPos.x - dx * 0.2)), y: Math.max(0, Math.min(100, startPos.y - dy * 0.2)) }); }; const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp); }
          },
            React.createElement('div', { className: "w-full h-full rounded-full overflow-hidden relative" },
                React.createElement('img', { src: profilePictureUrl, alt: name, className: "absolute inset-0 w-full h-full object-cover pointer-events-none block", style: { objectPosition: `${imagePosition.x}% ${imagePosition.y}%` } }),
                React.createElement('div', { className: "absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/20 pointer-events-none text-white text-xs font-bold" }, "Przesuń")
            )
          )
        ),
        React.createElement('main', { className: "flex flex-row flex-grow" },
          React.createElement('div', { className: "w-[38%] pl-10 pr-6 order-1 flex flex-col", style: { paddingTop: hasImage ? '125px' : '40px' } },
            React.createElement('div', { className: "bg-gray-100 p-6 flex-grow" },
                dob && React.createElement('div', { className: "mb-6" }, React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-widest uppercase mb-1" }, t.previewDob), React.createElement('p', { className: "text-sm text-black" }, dob)),
                personalDetails?.length > 0 && React.createElement('div', { className: "mb-6" }, React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-widest uppercase mb-1" }, t.previewQual), React.createElement('ul', { className: "list-disc pl-5 space-y-1 text-sm" }, personalDetails.map(d => React.createElement('li', { key: d.id }, d.text)))),
                skills?.length > 0 && React.createElement('div', { className: "mb-6" }, React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-widest uppercase mb-1" }, t.previewSkills), React.createElement('ul', { className: "list-disc pl-5 space-y-1 text-sm" }, skills.map(s => React.createElement('li', { key: s.id }, s.text)))),
                languages?.length > 0 && React.createElement('div', null, React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-widest uppercase mb-1" }, t.previewLang), React.createElement('ul', { className: "list-disc pl-5 space-y-1 text-sm" }, languages.map(l => React.createElement('li', { key: l.id }, l.text))))
            )
          ),
          React.createElement('div', { className: "w-[62%] p-6 pr-10 pt-20 order-2 flex flex-col" },
            React.createElement('div', { className: "w-full text-center text-4xl font-bold text-gray-300 tracking-widest uppercase mb-6" }, t.previewCV),
            workExperience?.length > 0 && React.createElement(React.Fragment, null, React.createElement(SectionTitle, null, t.previewExp), workExperience.map(exp => React.createElement('div', { key: exp.id, className: "mb-6" }, 
                React.createElement('p', { className: "text-sm uppercase" }, 
                    React.createElement('span', { className: "font-bold" }, exp.company),
                    exp.jobTitle && ` - ${exp.jobTitle}`
                ), 
                React.createElement('p', { className: "text-xs text-black my-2" }, exp.dateRange), 
                React.createElement('ul', { className: "list-disc pl-5 text-xs space-y-1" }, exp.tasks.map(task => React.createElement('li', { key: task.id }, task.text)))
            ))),
            education?.length > 0 && React.createElement('div', { className: "mt-8" }, React.createElement(SectionTitle, null, t.previewEdu), education.map(edu => React.createElement('div', { key: edu.id, className: "mb-6" }, React.createElement('p', { className: "font-bold text-sm uppercase" }, `${edu.schoolName} - ${edu.degree}`), React.createElement('p', { className: "text-xs text-black my-2" }, edu.dateRange), edu.description && React.createElement('p', { className: "text-xs" }, edu.description)))),
            React.createElement('div', { className: 'flex-grow min-h-[24px]' }),
            React.createElement('div', { className: 'pt-6 pb-8 flex justify-end cv-logo-wrapper' }, React.createElement('img', { src: "logo-covebo-icon.png", alt: "Logo", className: "w-24 h-auto" }))
          )
        )
      );
    };

    const Section = ({ title, children, description, defaultOpen = false, draggable = false, onDragStart, onDragOver, onDrop, isDragging = false }) => {
      const [isOpen, setIsOpen] = useState(defaultOpen);
      return React.createElement('div', { className: `mb-4 border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm transition-all ${isDragging ? 'drag-ghost' : ''}`, draggable, onDragStart, onDragOver, onDrop },
        React.createElement('div', { className: "flex items-center bg-gray-50 border-b border-gray-100" },
          draggable && React.createElement('div', { className: "pl-3 text-gray-400 cursor-grab active:cursor-grabbing" }, React.createElement(DragHandleIcon, null)),
          React.createElement('button', { onClick: () => setIsOpen(!isOpen), className: "flex-grow flex justify-between items-center p-4 hover:bg-gray-100 text-left" },
            React.createElement('div', null, React.createElement('h3', { className: "text-lg font-bold text-gray-800 leading-none" }, title), description && React.createElement('p', { className: "text-[10px] text-gray-500 mt-1 font-normal" }, description)),
            React.createElement(ChevronIcon, { className: `w-5 h-5 text-gray-500 transform transition-transform ${isOpen ? 'rotate-180' : ''}` })
          )
        ),
        isOpen && React.createElement('div', { className: "p-4 bg-gray-50/30" }, children)
      );
    };

    const CvForm = ({ cvData, setCvData, lang, setLang }) => {
      const t = translations[lang];
      const [draggedItemIndex, setDraggedItemIndex] = useState(null);
      const [showImport, setShowImport] = useState(false);
      const [importHtml, setImportHtml] = useState(""); // State for HTML content
      const [isReading, setIsReading] = useState(false);
      const fileInputRef = useRef(null);
      const editorRef = useRef(null); // Ref for contentEditable div
      const [toast, setToast] = useState(null);

      const showToast = (msg) => {
          setToast(msg);
          setTimeout(() => setToast(null), 2000);
      };

      const moveWorkExperience = (fromIndex, toIndex) => {
        const updated = [...cvData.workExperience];
        const [movedItem] = updated.splice(fromIndex, 1);
        updated.splice(toIndex, 0, movedItem);
        setCvData(prev => ({ ...prev, workExperience: updated }));
      };

      const handleAssignSelection = (type) => {
          // Use window.getSelection() for contentEditable
          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          
          // Ensure selection is inside our editor
          if (editorRef.current && !editorRef.current.contains(selection.anchorNode)) {
               alert(t.selectionEmpty);
               return;
          }

          const selectedText = selection.toString().trim();

          if (!selectedText) {
              alert(t.selectionEmpty);
              return;
          }

          switch (type) {
              case 'name':
                  setCvData(prev => ({ ...prev, name: selectedText }));
                  showToast("Przypisano imię!");
                  break;
              case 'work': {
                  const lines = selectedText.split('\n');
                  const dateRegex = /(\d{4}|obecnie|present|now|\d{2}\.\d{4})/i;
                  const dateMatch = lines[0].match(dateRegex);
                  const newExp = {
                      id: generateUniqueId(),
                      dateRange: dateMatch ? lines[0] : 'Daty do ustalenia',
                      company: dateMatch && lines[1] ? lines[1] : (lines[0] || 'Firma'),
                      jobTitle: 'Stanowisko',
                      tasks: lines.slice(dateMatch ? 2 : 1).map(l => ({ id: generateUniqueId(), text: l }))
                  };
                  setCvData(prev => ({ ...prev, workExperience: [...prev.workExperience, newExp] }));
                  showToast("Dodano doświadczenie!");
                  break;
              }
              case 'education': {
                  const lines = selectedText.split('\n');
                  const dateRegex = /(\d{4})/i;
                  const dateMatch = lines[0].match(dateRegex);
                   const newEdu = {
                      id: generateUniqueId(),
                      dateRange: dateMatch ? lines[0] : 'Daty do ustalenia',
                      schoolName: dateMatch && lines[1] ? lines[1] : (lines[0] || 'Szkoła'),
                      degree: 'Kierunek',
                      description: ''
                  };
                  setCvData(prev => ({ ...prev, education: [...prev.education, newEdu] }));
                  showToast("Dodano edukację!");
                  break;
              }
              case 'skills': 
                  const newSkills = selectedText.split('\n').map(l => ({ id: generateUniqueId(), text: l.replace(/^[•\-\*]\s*/, '') }));
                  setCvData(prev => ({ ...prev, skills: [...prev.skills, ...newSkills] }));
                  showToast("Dodano umiejętności!");
                  break;
              case 'languages':
                  const newLangs = selectedText.split('\n').map(l => ({ id: generateUniqueId(), text: l.replace(/^[•\-\*]\s*/, '') }));
                  setCvData(prev => ({ ...prev, languages: [...prev.languages, ...newLangs] }));
                   showToast("Dodano języki!");
                  break;
              case 'qualifications':
                  const newQuals = selectedText.split('\n').map(l => ({ id: generateUniqueId(), text: l.replace(/^[•\-\*]\s*/, '') }));
                  setCvData(prev => ({ ...prev, personalDetails: [...prev.personalDetails, ...newQuals] }));
                   showToast("Dodano uprawnienia!");
                  break;
          }

          // USUWANIE ZAZNACZENIA PO PRZYPISANIU
          try {
             selection.deleteFromDocument();
          } catch(e) {
             console.error("Błąd usuwania zaznaczenia:", e);
          }
      };

      const handleFileRead = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setIsReading(true);
        try {
            let extractedHtml = "";
            if (file.type === 'application/pdf') {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const styles = textContent.styles; // Metadata o czcionkach

                    let lastY = null;
                    let pageHtml = "";
                    
                    const items = textContent.items.sort((a, b) => {
                        if (Math.abs(b.transform[5] - a.transform[5]) > 5) { 
                            return b.transform[5] - a.transform[5]; 
                        }
                        return a.transform[4] - b.transform[4];
                    });

                    for (const item of items) {
                        // Sprawdzanie czy czcionka jest pogrubiona
                        let isBold = false;
                        if (item.fontName) {
                            if (item.fontName.toLowerCase().includes('bold') || item.fontName.toLowerCase().includes('bd')) {
                                isBold = true;
                            }
                            else if (styles && styles[item.fontName]) {
                                const fontData = styles[item.fontName];
                                if (fontData.fontFamily && (
                                    fontData.fontFamily.toLowerCase().includes('bold') || 
                                    fontData.fontFamily.toLowerCase().includes('uu') || 
                                    fontData.descent < -0.3
                                )) {
                                    isBold = true;
                                }
                            }
                        }

                        let chunk = item.str;
                        if (isBold) {
                            chunk = `<b>${chunk}</b>`;
                        }

                        if (lastY !== null) {
                            const diff = Math.abs(item.transform[5] - lastY);
                            // Większy odstęp (>20) sugeruje nowy akapit
                            if (diff > 20) {
                                pageHtml += "<br/><br/>";
                            } else if (diff > 8) {
                                pageHtml += "<br/>";
                            } else {
                                pageHtml += " ";
                            }
                        }
                        pageHtml += chunk;
                        lastY = item.transform[5];
                    }
                    extractedHtml += pageHtml + "<br/><br/>";
                }
            } else if (file.type.startsWith('image/')) {
                 const { data: { text } } = await Tesseract.recognize(file, 'pol+eng');
                 // Zamiana podwójnych nowych linii na odstęp
                 extractedHtml = text.replace(/\n\n/g, "<br/><br/>").replace(/\n/g, "<br/>");
            } else if (file.type === 'text/plain') {
                const text = await file.text();
                extractedHtml = text.replace(/\n/g, "<br/>");
            } else {
                alert("Obsługiwane tylko PDF, obrazy i TXT");
            }
            
            if (extractedHtml) {
                setImportHtml(extractedHtml);
            }
        } catch (err) {
            console.error(err);
            alert("Błąd odczytu pliku.");
        } finally {
            setIsReading(false);
            if (e.target) e.target.value = '';
        }
      };

      return React.createElement('div', { id: "cv-form-container", className: "p-6 bg-white shadow-xl h-full overflow-y-auto w-full md:w-1/2 lg:w-2/5 relative" },
        toast && React.createElement('div', { className: "fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce" }, toast),
        React.createElement('div', { className: "flex justify-between items-center mb-6" }, 
            React.createElement('h2', { className: "text-2xl font-bold text-red-700" }, t.editorTitle), 
            React.createElement('div', { className: "flex gap-2" }, ['pl', 'en'].map(l => React.createElement('button', { key: l, onClick: () => setLang(l), className: `px-3 py-1 text-sm font-medium rounded transition border ${lang === l ? 'bg-red-600 text-white border-red-600' : 'bg-white text-gray-600 border-gray-300'}` }, l.toUpperCase())))
        ),
        
        // --- SEKCJA IMPORTU (DWUKOLUMNOWA) ---
        React.createElement('div', { className: "mb-6" },
            !showImport ? 
            React.createElement('button', { 
                onClick: () => setShowImport(true),
                className: "w-full py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition shadow-sm border border-red-600"
            }, t.importBtn) :
            React.createElement('div', { className: "p-4 border-2 border-red-200 rounded-lg bg-red-50/50 shadow-inner" },
                React.createElement('div', { className: "flex justify-between mb-2 items-center" },
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('input', { type: "file", ref: fileInputRef, onChange: handleFileRead, accept: ".pdf,.txt,image/*", className: "hidden" }),
                        React.createElement('button', { 
                            onClick: () => fileInputRef.current.click(), 
                            disabled: isReading,
                            className: "text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-gray-700 font-medium flex items-center gap-2" 
                        }, isReading ? t.importing : t.loadFileBtn)
                    ),
                    React.createElement('button', { onClick: () => setShowImport(false), className: "text-xs text-gray-500 hover:text-gray-700 font-bold" }, "ZAMKNIJ ✕")
                ),
                 // Instrukcja dla użytkownika (Top)
                React.createElement('p', { className: "text-sm text-gray-700 mb-4 font-medium" }, t.importIntro),

                React.createElement('div', { className: "flex flex-col md:flex-row gap-4" },
                    // LEWA KOLUMNA: EDYTOR RICH TEXT
                    React.createElement('div', { className: "flex-grow" },
                         React.createElement('p', { className: "text-[10px] text-gray-500 mb-1 italic" }, "1. Zaznacz tekst myszką"),
                         React.createElement('div', {
                            ref: editorRef,
                            contentEditable: true,
                            suppressContentEditableWarning: true,
                            dangerouslySetInnerHTML: { __html: importHtml },
                            className: "rich-editor w-full h-80 p-3 border border-red-300 rounded-lg text-sm font-sans leading-loose text-gray-800 bg-white focus:ring-2 focus:ring-red-200 outline-none overflow-y-auto shadow-inner selection:bg-red-200 selection:text-red-900"
                        })
                    ),
                    // PRAWA KOLUMNA: PRZYCISKI
                    React.createElement('div', { className: "w-full md:w-48 flex flex-col gap-2" },
                         React.createElement('p', { className: "text-[10px] text-gray-500 mb-1 italic" }, "2. Kliknij kategorię"),
                         React.createElement('button', { onClick: () => handleAssignSelection('name'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignName),
                         React.createElement('button', { onClick: () => handleAssignSelection('work'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignWork),
                         React.createElement('button', { onClick: () => handleAssignSelection('education'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignEdu),
                         React.createElement('div', { className: "h-px bg-gray-200 my-1" }),
                         React.createElement('button', { onClick: () => handleAssignSelection('qualifications'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignQuals),
                         React.createElement('button', { onClick: () => handleAssignSelection('languages'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignLangs),
                         React.createElement('button', { onClick: () => handleAssignSelection('skills'), className: "w-full text-left px-3 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded text-xs font-medium transition text-gray-700 shadow-sm" }, t.assignSkills)
                    )
                ),
                 // Instrukcja (Bottom)
                React.createElement('p', { className: "text-sm text-gray-600 mt-4 italic text-center font-medium" }, t.importOutro)
            )
        ),

        React.createElement(Section, { title: t.basicInfo, defaultOpen: true },
          React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.fullName), React.createElement('input', { type: "text", value: cvData.name, onChange: (e) => setCvData(prev => ({...prev, name: e.target.value})), className: "w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-red-500" })),
          React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.dob), React.createElement('input', { type: "text", value: cvData.dob, onChange: (e) => setCvData(prev => ({...prev, dob: e.target.value})), className: "w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-red-500" })),
          React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.profilePic), React.createElement('input', { type: "file", onChange: (e) => { const f = e.target.files[0]; if(f){ const r = new FileReader(); r.onload = () => setCvData(prev => ({...prev, profilePictureUrl: r.result, imagePosition: {x:50,y:50}})); r.readAsDataURL(f); } }, accept: "image/*", className: "w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-red-50 file:text-red-700 hover:file:bg-red-100" }))
        ),
        React.createElement(Section, { title: t.workExp, description: t.workExpDesc, defaultOpen: true },
          cvData.workExperience.map((work, index) => React.createElement(Section, { 
              key: work.id, title: work.company || t.newWorkExp, defaultOpen: index === 0, draggable: true, isDragging: draggedItemIndex === index,
              onDragStart: () => setDraggedItemIndex(index), onDragOver: (e) => e.preventDefault(),
              onDrop: () => { if (draggedItemIndex !== null && draggedItemIndex !== index) { moveWorkExperience(draggedItemIndex, index); } setDraggedItemIndex(null); }
            },
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.company), React.createElement('input', { type: "text", value: work.company, onChange: (e) => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, company: e.target.value} : w)})), className: "w-full border border-gray-300 rounded p-2 text-sm font-bold" })),
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.jobTitle), React.createElement('input', { type: "text", value: work.jobTitle, onChange: (e) => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, jobTitle: e.target.value} : w)})), className: "w-full border border-gray-300 rounded p-2 text-sm" })),
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.period), React.createElement('input', { type: "text", value: work.dateRange, onChange: (e) => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, dateRange: e.target.value} : w)})), className: "w-full border border-gray-300 rounded p-2 text-sm" })),
            React.createElement('div', { className: "mb-3" },
              React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.responsibilities),
              work.tasks.map(task => React.createElement('div', { key: task.id, className: "flex items-center gap-2 mb-2" },
                React.createElement('input', { type: "text", value: task.text, onChange: (e) => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, tasks: w.tasks.map(tk => tk.id === task.id ? {...tk, text: e.target.value} : tk)} : w)})), className: "flex-grow border border-gray-300 rounded p-2 text-sm" }),
                React.createElement('button', { onClick: () => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, tasks: w.tasks.filter(tk => tk.id !== task.id)} : w)})), className: "text-red-500 font-bold" }, "×")
              )),
              React.createElement('button', { onClick: () => setCvData(prev => ({...prev, workExperience: prev.workExperience.map(w => w.id === work.id ? {...w, tasks: [...w.tasks, {id: generateUniqueId(), text: ''}]} : w)})), className: "text-xs text-blue-600 hover:underline" }, t.addDuty)
            ),
            React.createElement('button', { onClick: () => setCvData(prev => ({...prev, workExperience: prev.workExperience.filter(w => w.id !== work.id)})), className: "mt-4 text-xs text-red-600 hover:underline" }, t.removeWorkExp)
          )),
          React.createElement('button', { onClick: () => setCvData(prev => ({...prev, workExperience: [...prev.workExperience, {id: generateUniqueId(), company: '', jobTitle: '', dateRange: '', tasks: [{id: generateUniqueId(), text: ''}]}]})), className: "mt-4 w-full py-2 border border-red-500 text-red-600 rounded-md font-medium hover:bg-red-50 transition" }, t.addWorkExp)
        ),
        [
          { key: 'personalDetails', title: t.sectionQual }, { key: 'languages', title: t.sectionLang }, { key: 'skills', title: t.sectionSkills }
        ].map(({ key, title }) => React.createElement(Section, { key: key, title, description: t.listDesc, defaultOpen: false },
          cvData[key].map(item => React.createElement('div', { key: item.id, className: "flex items-center gap-2 mb-2" },
            React.createElement('input', { type: "text", value: item.text, onChange: (e) => setCvData(p => ({ ...p, [key]: p[key].map(i => i.id === item.id ? {...i, text: e.target.value} : i) })), className: "flex-grow border border-gray-300 rounded p-2 text-sm" }),
            React.createElement('button', { onClick: () => setCvData(p => ({ ...p, [key]: p[key].filter(i => i.id !== item.id) })), className: "text-red-500 font-bold" }, "×")
          )),
          React.createElement('button', { onClick: () => setCvData(p => ({ ...p, [key]: [...p[key], {id: generateUniqueId(), text: ''}] })), className: "mt-2 text-xs text-blue-600 hover:underline" }, "+ Dodaj")
        )),
        React.createElement(Section, { title: t.education, description: t.eduDesc, defaultOpen: false },
          cvData.education.map((edu) => React.createElement(Section, { key: edu.id, title: edu.schoolName || t.newEdu, defaultOpen: true },
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.school), React.createElement('input', { type: "text", value: edu.schoolName, onChange: (e) => setCvData(p => ({...p, education: p.education.map(ed => ed.id === edu.id ? {...ed, schoolName: e.target.value} : ed)})), className: "w-full border border-gray-300 rounded p-2 text-sm" })),
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.degree), React.createElement('input', { type: "text", value: edu.degree, onChange: (e) => setCvData(p => ({...p, education: p.education.map(ed => ed.id === edu.id ? {...ed, degree: e.target.value} : ed)})), className: "w-full border border-gray-300 rounded p-2 text-sm" })),
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.period), React.createElement('input', { type: "text", value: edu.dateRange, onChange: (e) => setCvData(p => ({...p, education: p.education.map(ed => ed.id === edu.id ? {...ed, dateRange: e.target.value} : ed)})), className: "w-full border border-gray-300 rounded p-2 text-sm" })),
            React.createElement('div', { className: "mb-3" }, React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, t.description), React.createElement('textarea', { value: edu.description, onChange: (e) => setCvData(p => ({...p, education: p.education.map(ed => ed.id === edu.id ? {...ed, description: e.target.value} : ed)})), className: "w-full border border-gray-300 rounded p-2 text-sm h-20" })),
            React.createElement('button', { onClick: () => setCvData(p => ({ ...p, education: p.education.filter(e => e.id !== edu.id) })), className: "mt-4 text-xs text-red-600 hover:underline" }, t.removeEdu)
          )),
          React.createElement('button', { onClick: () => setCvData(p => ({...p, education: [...p.education, {id: generateUniqueId(), schoolName: '', degree: '', dateRange: '', description: ''}]})), className: "mt-4 w-full py-2 border border-red-500 text-red-600 rounded-md font-medium hover:bg-red-50 transition" }, t.addEdu)
        ),
        React.createElement('div', { className: "mt-8 sticky bottom-0 bg-white pt-4 pb-4 border-t" }, React.createElement('button', { onClick: () => generatePdf('cv-document'), className: "w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition shadow-md" }, t.downloadPdf))
      );
    };
    
    // --- MAIN APP ---
    const defaultData = {
      name: 'Jan Kowalski', dob: '01.01.1990', profilePictureUrl: 'https://placehold.co/180x180/E31D2A/ffffff?text=ZDJĘCIE', imagePosition: { x: 50, y: 50 },
      personalDetails: [{ id: generateUniqueId(), text: 'Prawo jazdy kat. B' }], skills: [{ id: generateUniqueId(), text: 'Obsługa pakowarki automatycznej' }], languages: [{ id: generateUniqueId(), text: 'Angielski - B1' }],
      workExperience: [{ id: generateUniqueId(), company: 'Fabryka Mebli', jobTitle: 'Pracownik Produkcji', dateRange: '03.2020 - obecnie', tasks: [{ id: generateUniqueId(), text: 'Obsługa maszyn' }] }],
      education: [{ id: generateUniqueId(), schoolName: 'Technikum nr 1', degree: 'Technik Logistyk', dateRange: '2014-2018', description: '' }]
    };
    
    const App = () => {
      const [cvData, setCvData] = useState(defaultData); const [view, setView] = useState('form'); const [lang, setLang] = useState('pl');
      return React.createElement('div', { className: `min-h-screen flex flex-col md:flex-row ${view === 'form' ? 'mobile-view-form' : 'mobile-view-preview'}` },
        React.createElement('div', { className: "md:hidden bg-white p-4 border-b flex justify-around sticky top-0 z-10 shadow-sm" },
            React.createElement('button', { onClick: () => setView('form'), className: `px-4 py-2 text-sm font-medium rounded-lg ${view === 'form' ? 'bg-red-600 text-white' : 'text-gray-600'}` }, "Edytor"),
            React.createElement('button', { onClick: () => setView('preview'), className: `px-4 py-2 text-sm font-medium rounded-lg ${view === 'preview' ? 'bg-red-600 text-white' : 'text-gray-600'}` }, "Podgląd")
        ),
        React.createElement(CvForm, { cvData, setCvData, lang, setLang }),
        React.createElement('div', { id: "cv-preview-container", className: "bg-gray-100 flex-grow w-full md:w-1/2 lg:w-3/5 overflow-auto flex flex-col" },
            React.createElement('div', { className: "sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b p-3 flex justify-end gap-2 shadow-sm" },
                React.createElement('button', { onClick: () => generatePdf('cv-document'), className: "flex items-center gap-2 bg-[#E31D2A] text-white px-3 py-2 rounded text-xs" }, React.createElement(DownloadIcon, { className: "w-4 h-4" }), "Pobierz PDF")
            ),
            React.createElement('div', { className: "p-6 md:p-10 flex justify-center min-w-fit" },
                 React.createElement(CvPreview, { cvData, id: "cv-document", className: "w-[210mm] h-auto min-h-fit", onImagePositionChange: (p) => setCvData(prev => ({ ...prev, imagePosition: p })), lang })
            )
        )
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(React.StrictMode, null, React.createElement(App)));
  </script>
</body>
</html>
